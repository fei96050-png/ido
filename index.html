<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KDK Token | Kodiak Finance Style DApp</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        :root {
            --primary: #0a0b1e;
            --secondary: #141632;
            --accent: #3a86ff;
            --accent-hover: #2667cc;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: #2d3748;
            --card-bg: rgba(20, 22, 50, 0.8);
            --gradient: linear-gradient(135deg, #3a86ff 0%, #8338ec 100%);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        body {
            background-color: var(--primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(58, 134, 255, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(131, 56, 236, 0.1) 0%, transparent 20%);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header & Navigation */
        header {
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            background-color: rgba(10, 11, 30, 0.9);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 1.5rem;
        }

        .logo-icon {
            color: var(--accent);
            font-size: 1.8rem;
        }

        .nav-links {
            display: none;
        }

        .wallet-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .wallet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(58, 134, 255, 0.3);
        }

        .wallet-btn.connected {
            background: var(--success);
        }

        /* Hero Section */
        .hero {
            padding: 40px 0 30px;
            text-align: center;
        }

        .hero h1 {
            font-size: 2.2rem;
            margin-bottom: 16px;
            background: linear-gradient(90deg, #3a86ff, #8338ec);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p {
            color: var(--text-secondary);
            font-size: 1rem;
            max-width: 700px;
            margin: 0 auto 30px;
            line-height: 1.6;
        }

        /* Stats */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Referral Banner */
        .referral-banner {
            background: linear-gradient(90deg, rgba(58, 134, 255, 0.1), rgba(131, 56, 236, 0.1));
            border: 1px solid rgba(58, 134, 255, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .referral-icon {
            color: var(--accent);
            font-size: 1.3rem;
        }

        .referral-text {
            flex: 1;
            font-size: 0.9rem;
        }

        .referral-text strong {
            color: var(--accent);
        }

        .copy-referral-btn {
            background: rgba(58, 134, 255, 0.2);
            border: 1px solid rgba(58, 134, 255, 0.5);
            color: var(--accent);
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .copy-referral-btn:hover {
            background: rgba(58, 134, 255, 0.3);
        }

        /* Main Content */
        .main-content {
            margin-bottom: 50px;
        }

        /* Cards */
        .card {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            margin-bottom: 25px;
        }

        .card-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--accent);
        }

        /* Form Elements */
        .input-group {
            margin-bottom: 18px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon input {
            width: 100%;
            padding: 14px 14px 14px 45px;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .input-with-icon input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.2);
        }

        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .input-hint {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .price-display {
            background: rgba(58, 134, 255, 0.1);
            border-radius: 12px;
            padding: 14px;
            margin: 18px 0;
            text-align: center;
            border: 1px solid rgba(58, 134, 255, 0.3);
        }

        .price-display .price {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--accent);
        }

        .price-display .label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        /* Buttons */
        .btn {
            display: block;
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            margin-top: 10px;
        }

        .btn-primary {
            background: var(--gradient);
            color: white;
            box-shadow: 0 5px 15px rgba(58, 134, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(58, 134, 255, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Status */
        .status-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 25px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .status-label {
            color: var(--text-secondary);
        }

        .status-value {
            font-weight: 600;
        }

        .status-value.active {
            color: var(--success);
        }

        .status-value.inactive {
            color: var(--error);
        }

        /* Footer */
        footer {
            padding: 30px 0;
            border-top: 1px solid var(--border);
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .footer-links a {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.3s ease;
            font-size: 0.85rem;
        }

        .footer-links a:hover {
            color: var(--accent);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background-color: var(--secondary);
            border-left: 4px solid var(--accent);
            padding: 14px 18px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 280px;
            max-width: 350px;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.error {
            border-left-color: var(--error);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Mobile Menu */
        .mobile-menu-btn {
            display: block;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        @media (min-width: 768px) {
            .mobile-menu-btn {
                display: none;
            }
            .nav-links {
                display: flex;
                gap: 25px;
            }
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (max-width: 767px) {
            .hero h1 {
                font-size: 1.8rem;
            }
            .card {
                padding: 20px;
            }
            .stats-container {
                grid-template-columns: 1fr 1fr;
            }
            .referral-banner {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            .hero h1 {
                font-size: 1.6rem;
            }
            .card-title {
                font-size: 1.2rem;
            }
        }

        /* Short address display */
        .short-address {
            font-family: monospace;
            background: rgba(255, 255, 255, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* Token info section */
        .token-info {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .token-info-item {
            flex: 1;
            min-width: 150px;
        }

        .token-info-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .token-info-value {
            font-weight: 600;
            font-size: 1rem;
        }

        .referral-rewards {
            background: linear-gradient(90deg, rgba(10, 191, 158, 0.1), rgba(58, 134, 255, 0.1));
            border: 1px solid rgba(10, 191, 158, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .referral-rewards-title {
            color: var(--success);
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .referral-rewards-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container nav-container">
            <div class="logo">
                <i class="fas fa-bear logo-icon"></i>
                <span>KDK Token</span>
            </div>
            
            <button class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="nav-links">
                <a href="#home">Home</a>
                <a href="#buy">Buy</a>
                <a href="#about">About</a>
            </div>
            
            <button id="connectWallet" class="wallet-btn">
                <i class="fas fa-wallet"></i>
                <span>Connect Wallet</span>
            </button>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero" id="home">
        <div class="container">
            <h1>KDK Token Platform</h1>
            <p>
                Kodiak is a vertically integrated decentralized liquidity platform that supports token issuance, trading, and advanced liquidity management. 
                Incubated by Berachain and backed by top investment firms.
            </p>
            
            <div class="referral-banner" id="referralBanner" style="display: none;">
                <i class="fas fa-user-friends referral-icon"></i>
                <div class="referral-text">
                    Using referral from: <strong id="referrerAddress" class="short-address">0x...</strong>
                </div>
                <button class="copy-referral-btn" id="copyReferralLink">
                    <i class="fas fa-copy"></i> Copy Your Link
                </button>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="tokenPrice">$0.05</div>
                    <div class="stat-label">Token Price</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="userBalance">0 KDK</div>
                    <div class="stat-label">Your Balance</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="saleStatus">Active</div>
                    <div class="stat-label">Sale Status</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="network">BSC</div>
                    <div class="stat-label">Network</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <section class="container main-content">
        <!-- Buy Card -->
        <div class="card">
            <div class="card-title">
                <i class="fas fa-shopping-cart"></i>
                <span>Buy KDK Tokens</span>
            </div>
            
            <div class="token-info">
                <div class="token-info-item">
                    <div class="token-info-label">Token Name</div>
                    <div class="token-info-value" id="tokenName">KDK</div>
                </div>
                <div class="token-info-item">
                    <div class="token-info-label">Token Symbol</div>
                    <div class="token-info-value" id="tokenSymbol">KDK</div>
                </div>
                <div class="token-info-item">
                    <div class="token-info-label">Decimals</div>
                    <div class="token-info-value" id="tokenDecimals">18</div>
                </div>
                <div class="token-info-item">
                    <div class="token-info-label">Total Supply</div>
                    <div class="token-info-value" id="totalSupply">1,000,000,000</div>
                </div>
            </div>
            
            <div class="price-display">
                <div class="price">$0.05 per token</div>
                <div class="label">Minimum purchase: 0.4 BNB</div>
            </div>
            
            <div class="referral-rewards">
                <div class="referral-rewards-title">20% Referral Rewards!</div>
                <div class="referral-rewards-desc">When someone buys using your referral link, you earn 20% of their purchase in KDK tokens</div>
            </div>
            
            <div class="input-group">
                <label class="input-label">BNB Amount</label>
                <div class="input-with-icon">
                    <i class="fas fa-coins input-icon"></i>
                    <input type="number" id="bnbAmount" placeholder="0.4" min="0.4" step="0.1" value="0.4">
                </div>
                <div class="input-hint">Minimum 0.4 BNB required for purchase</div>
            </div>
            
            <div class="input-group">
                <label class="input-label">Referral Address (Auto-filled)</label>
                <div class="input-with-icon">
                    <i class="fas fa-user-friends input-icon"></i>
                    <input type="text" id="referralAddress" placeholder="0x..." readonly>
                </div>
                <div class="input-hint">Automatically set from referral link. Earn 20% referral rewards!</div>
            </div>
            
            <div class="input-group">
                <label class="input-label">You will receive</label>
                <div class="input-with-icon">
                    <i class="fas fa-gift input-icon"></i>
                    <input type="text" id="tokensToReceive" readonly value="0 KDK">
                </div>
            </div>
            
            <button id="buyTokens" class="btn btn-primary">
                <span>Buy Tokens</span>
            </button>
            
            <div class="status-container">
                <div class="status-item">
                    <span class="status-label">Sale Active</span>
                    <span id="saleActiveStatus" class="status-value active">Yes</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Remaining Blocks</span>
                    <span id="remainingBlocks" class="status-value">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Connected Address</span>
                    <span id="connectedAddress" class="status-value short-address">Not connected</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Your Referral Link</span>
                    <span id="yourReferralLink" class="status-value" style="color: var(--accent); cursor: pointer; font-size: 0.85rem;" title="Click to copy">Click to generate</span>
                </div>
            </div>
        </div>
        
        <!-- About Section -->
        <div class="card">
            <div class="card-title">
                <i class="fas fa-chart-line"></i>
                <span>About Kodiak Finance</span>
            </div>
            
            <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 15px; font-size: 0.95rem;">
                Kodiak holds over 90% of the spot and perpetual contract decentralized exchange market share on the Berachain network, 
                making it the highest revenue protocol on the network. Its full-stack DeFi suite covers spot and perpetual trading, 
                aggregation services, automated liquidity management, incentive layers, automatic compound vaults, validators, and no-code token deployment.
            </p>
            
            <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 15px; font-size: 0.95rem;">
                Kodiak ranks as the second largest liquidity management platform by TVL, among the top 16 DEXs, 
                among the top 70 DEXs by trading volume, among the top 160 protocols by fees, and among the top 40 platforms by DEX fees.
            </p>
            
            <p style="color: var(--text-secondary); line-height: 1.6; font-size: 0.95rem;">
                Kodiak is rapidly advancing toward its vision—to become the only end-to-end platform needed for every user's DeFi journey.
            </p>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-links">
                <a href="https://www.kodiak.finance/" target="_blank">Kodiak Finance</a>
                <a href="#" id="addToken">Add KDK to Wallet</a>
                <a href="#" id="switchNetwork">Switch to BSC</a>
            </div>
            <p>© 2025 KDK Token DApp. All rights reserved.</p>
            <p style="margin-top: 10px; font-size: 0.8rem; color: rgba(160, 174, 192, 0.7);">
                This interface is designed for TokenPocket wallet on BSC network.
            </p>
        </div>
    </footer>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // Contract details
        const contractAddress = "0x6bfcA5254F4C106AD9173434da7DC26C5120eB6C";
        
        // Contract ABI (simplified version for the required functions)
        const contractABI = [
            {
                "inputs": [],
                "name": "buy",
                "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getBlock",
                "outputs": [
                    {"internalType": "bool", "name": "swAirdorp", "type": "bool"},
                    {"internalType": "bool", "name": "swSale", "type": "bool"},
                    {"internalType": "uint256", "name": "sPrice", "type": "uint256"},
                    {"internalType": "uint256", "name": "sMaxBlock", "type": "uint256"},
                    {"internalType": "uint256", "name": "nowBlock", "type": "uint256"},
                    {"internalType": "uint256", "name": "balance", "type": "uint256"},
                    {"internalType": "uint256", "name": "airdropEth", "type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "address", "name": "account", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "name",
                "outputs": [{"internalType": "string", "name": "", "type": "string"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "symbol",
                "outputs": [{"internalType": "string", "name": "", "type": "string"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "decimals",
                "outputs": [{"internalType": "uint8", "name": "", "type": "uint8"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalSupply",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // Global variables
        let web3;
        let contract;
        let userAddress;
        let isConnected = false;
        let contractData = {};
        let currentReferrer = null; // The referrer address from URL or saved
        let userReferralLink = null;

        // DOM elements
        const connectWalletBtn = document.getElementById('connectWallet');
        const buyTokensBtn = document.getElementById('buyTokens');
        const bnbAmountInput = document.getElementById('bnbAmount');
        const tokensToReceiveInput = document.getElementById('tokensToReceive');
        const referralAddressInput = document.getElementById('referralAddress');
        const addTokenBtn = document.getElementById('addToken');
        const switchNetworkBtn = document.getElementById('switchNetwork');
        const userBalanceEl = document.getElementById('userBalance');
        const connectedAddressEl = document.getElementById('connectedAddress');
        const saleActiveStatusEl = document.getElementById('saleActiveStatus');
        const remainingBlocksEl = document.getElementById('remainingBlocks');
        const tokenNameEl = document.getElementById('tokenName');
        const tokenSymbolEl = document.getElementById('tokenSymbol');
        const tokenDecimalsEl = document.getElementById('tokenDecimals');
        const totalSupplyEl = document.getElementById('totalSupply');
        const saleStatusEl = document.getElementById('saleStatus');
        const referralBanner = document.getElementById('referralBanner');
        const referrerAddressEl = document.getElementById('referrerAddress');
        const copyReferralLinkBtn = document.getElementById('copyReferralLink');
        const yourReferralLinkEl = document.getElementById('yourReferralLink');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check URL for referral parameter
            checkURLForReferral();
            
            // Check if TokenPocket is installed
            if (typeof window.ethereum !== 'undefined') {
                console.log('TokenPocket or other Web3 wallet is installed!');
                // Try to connect automatically
                checkWalletConnection();
            } else {
                showToast('Please install TokenPocket wallet to use this DApp', 'warning');
            }
            
            // Setup event listeners
            setupEventListeners();
            
            // Update token calculation when BNB amount changes
            bnbAmountInput.addEventListener('input', updateTokenCalculation);
            
            // Initial token calculation
            updateTokenCalculation();
        });

        // Check URL for referral parameter
        function checkURLForReferral() {
            const urlParams = new URLSearchParams(window.location.search);
            const refParam = urlParams.get('ref');
            
            if (refParam && isValidEthereumAddress(refParam)) {
                // Save referrer address from URL
                currentReferrer = refParam.toLowerCase();
                localStorage.setItem('kdk_referrer', currentReferrer);
                
                // Show referral banner
                referralBanner.style.display = 'flex';
                referrerAddressEl.textContent = shortenAddress(currentReferrer);
                
                // Update referral input fields
                referralAddressInput.value = currentReferrer;
                
                showToast('Referral address detected and applied!', 'success');
            } else {
                // Check if we have a saved referrer in localStorage
                const savedReferrer = localStorage.getItem('kdk_referrer');
                if (savedReferrer && isValidEthereumAddress(savedReferrer)) {
                    currentReferrer = savedReferrer.toLowerCase();
                    referralBanner.style.display = 'flex';
                    referrerAddressEl.textContent = shortenAddress(currentReferrer);
                    referralAddressInput.value = currentReferrer;
                }
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Connect wallet button
            connectWalletBtn.addEventListener('click', connectWallet);
            
            // Buy tokens button
            buyTokensBtn.addEventListener('click', buyTokens);
            
            // Add token to wallet
            addTokenBtn.addEventListener('click', addTokenToWallet);
            
            // Switch network button
            switchNetworkBtn.addEventListener('click', switchToBSC);
            
            // Copy referral link button
            copyReferralLinkBtn.addEventListener('click', copyUserReferralLink);
            
            // Your referral link click
            yourReferralLinkEl.addEventListener('click', generateUserReferralLink);
        }

        // Check if wallet is already connected
        async function checkWalletConnection() {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        userAddress = accounts[0];
                        isConnected = true;
                        updateWalletUI();
                        initializeWeb3();
                    }
                } catch (error) {
                    console.error('Error checking wallet connection:', error);
                }
            }
        }

        // Connect wallet function
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showToast('Please install TokenPocket wallet first!', 'error');
                return;
            }
            
            try {
                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                if (accounts.length > 0) {
                    userAddress = accounts[0];
                    isConnected = true;
                    updateWalletUI();
                    initializeWeb3();
                    showToast('Wallet connected successfully!', 'success');
                    
                    // Generate user's referral link after connecting
                    generateUserReferralLink();
                }
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showToast('Failed to connect wallet. Please try again.', 'error');
            }
        }

        // Initialize Web3 and contract
        async function initializeWeb3() {
            if (typeof window.ethereum !== 'undefined') {
                // Use TokenPocket's provider
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(contractABI, contractAddress);
                
                // Load contract data
                await loadContractData();
                
                // Set up event listeners for wallet changes
                window.ethereum.on('accountsChanged', function(accounts) {
                    if (accounts.length === 0) {
                        // User disconnected wallet
                        userAddress = null;
                        isConnected = false;
                        updateWalletUI();
                        showToast('Wallet disconnected', 'warning');
                    } else {
                        // User switched account
                        userAddress = accounts[0];
                        updateWalletUI();
                        loadContractData();
                        generateUserReferralLink(); // Regenerate referral link for new address
                        showToast('Account changed', 'info');
                    }
                });
                
                window.ethereum.on('chainChanged', function() {
                    // Reload the page when network changes
                    window.location.reload();
                });
            } else {
                showToast('Please install TokenPocket wallet to use this DApp', 'error');
            }
        }

        // Load contract data
        async function loadContractData() {
            if (!contract || !userAddress) return;
            
            try {
                // Get contract status
                const contractStatus = await contract.methods.getBlock().call({from: userAddress});
                
                contractData = {
                    swAirdrop: contractStatus[0],
                    swSale: contractStatus[1],
                    sPrice: contractStatus[2],
                    sMaxBlock: contractStatus[3],
                    nowBlock: contractStatus[4],
                    userBalance: contractStatus[5],
                    airdropEth: contractStatus[6]
                };
                
                // Update UI with contract data
                updateContractDataUI();
                
                // Get token info
                const tokenName = await contract.methods.name().call();
                const tokenSymbol = await contract.methods.symbol().call();
                const decimals = await contract.methods.decimals().call();
                const totalSupply = await contract.methods.totalSupply().call();
                
                tokenNameEl.textContent = tokenName;
                tokenSymbolEl.textContent = tokenSymbol;
                tokenDecimalsEl.textContent = decimals;
                
                // Format total supply
                const totalSupplyFormatted = web3.utils.fromWei(totalSupply, 'ether');
                totalSupplyEl.textContent = parseFloat(totalSupplyFormatted).toLocaleString();
                
                // Get user token balance
                const userBalance = await contract.methods.balanceOf(userAddress).call();
                const userBalanceFormatted = web3.utils.fromWei(userBalance, 'ether');
                userBalanceEl.textContent = parseFloat(userBalanceFormatted).toLocaleString() + ' KDK';
                
                // Update token calculation with actual price
                updateTokenCalculation();
                
            } catch (error) {
                console.error('Error loading contract data:', error);
            }
        }

        // Update contract data UI
        function updateContractDataUI() {
            // Update sale status
            saleActiveStatusEl.textContent = contractData.swSale ? 'Yes' : 'No';
            saleActiveStatusEl.className = `status-value ${contractData.swSale ? 'active' : 'inactive'}`;
            
            // Update remaining blocks
            const remainingBlocks = contractData.sMaxBlock - contractData.nowBlock;
            remainingBlocksEl.textContent = remainingBlocks > 0 ? remainingBlocks : 'Sale Ended';
            
            // Update sale status in hero
            saleStatusEl.textContent = contractData.swSale ? 'Active' : 'Ended';
            saleStatusEl.style.color = contractData.swSale ? 'var(--success)' : 'var(--error)';
            
            // Update buttons based on status
            buyTokensBtn.disabled = !contractData.swSale;
        }

        // Update token calculation
        function updateTokenCalculation() {
            const bnbAmount = parseFloat(bnbAmountInput.value) || 0;
            
            if (bnbAmount < 0.4) {
                tokensToReceiveInput.value = 'Minimum 0.4 BNB required';
                buyTokensBtn.disabled = true;
                return;
            }
            
            buyTokensBtn.disabled = !contractData.swSale;
            
            // If we have contract data with actual price, use it
            if (contractData.sPrice) {
                // Calculate tokens based on contract price (sPrice is tokens per wei)
                const bnbInWei = web3.utils.toWei(bnbAmount.toString(), 'ether');
                const tokens = BigInt(bnbInWei) * BigInt(contractData.sPrice);
                const tokensFormatted = web3.utils.fromWei(tokens.toString(), 'ether');
                tokensToReceiveInput.value = parseFloat(tokensFormatted).toLocaleString() + ' KDK';
            } else {
                // Fallback calculation (approximate)
                const tokens = bnbAmount * 17400; // Based on contract default price
                tokensToReceiveInput.value = tokens.toLocaleString() + ' KDK';
            }
        }

        // Buy tokens function
        async function buyTokens() {
            if (!isConnected) {
                showToast('Please connect your wallet first', 'warning');
                return;
            }
            
            const bnbAmount = parseFloat(bnbAmountInput.value);
            
            if (bnbAmount < 0.4) {
                showToast('Minimum purchase is 0.4 BNB', 'error');
                return;
            }
            
            if (!contractData.swSale) {
                showToast('Token sale is not active', 'error');
                return;
            }
            
            try {
                // Convert BNB to wei
                const bnbInWei = web3.utils.toWei(bnbAmount.toString(), 'ether');
                
                // Get referral address - use the one from URL or saved
                let referAddress = currentReferrer;
                if (!referAddress || referAddress === userAddress.toLowerCase()) {
                    referAddress = userAddress; // Use own address if no valid referral
                }
                
                // Show loading state
                const originalText = buyTokensBtn.innerHTML;
                buyTokensBtn.innerHTML = '<div class="spinner"></div> Processing...';
                buyTokensBtn.disabled = true;
                
                // Execute buy transaction
                const result = await contract.methods.buy(referAddress).send({
                    from: userAddress,
                    value: bnbInWei
                });
                
                // Reset button
                buyTokensBtn.innerHTML = originalText;
                buyTokensBtn.disabled = false;
                
                showToast('Tokens purchased successfully!', 'success');
                
                // Reload contract data to update balances
                await loadContractData();
                
            } catch (error) {
                console.error('Error buying tokens:', error);
                buyTokensBtn.innerHTML = 'Buy Tokens';
                buyTokensBtn.disabled = false;
                
                if (error.code === 4001) {
                    showToast('Transaction was rejected', 'error');
                } else {
                    showToast('Transaction failed. Please try again.', 'error');
                }
            }
        }

        // Generate user's referral link
        function generateUserReferralLink() {
            if (!userAddress) {
                showToast('Please connect your wallet first', 'warning');
                return;
            }
            
            // Create referral link with user's address
            const baseUrl = window.location.origin + window.location.pathname;
            userReferralLink = `${baseUrl}?ref=${userAddress}`;
            
            // Update UI
            yourReferralLinkEl.textContent = shortenAddress(userAddress);
            yourReferralLinkEl.title = 'Click to copy: ' + userReferralLink;
            
            showToast('Your referral link has been generated!', 'success');
        }

        // Copy user's referral link to clipboard
        function copyUserReferralLink() {
            if (!userReferralLink) {
                showToast('Please generate your referral link first', 'warning');
                return;
            }
            
            navigator.clipboard.writeText(userReferralLink).then(() => {
                showToast('Referral link copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy link. Please try again.', 'error');
            });
        }

        // Switch to BSC network
        async function switchToBSC() {
            if (!window.ethereum) {
                showToast('Please install TokenPocket wallet first', 'error');
                return;
            }
            
            try {
                // Switch to BSC mainnet (chainId: 0x38 = 56)
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x38' }],
                });
                
                showToast('Switched to BSC network', 'success');
            } catch (error) {
                // If BSC network is not added, add it
                if (error.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [
                                {
                                    chainId: '0x38',
                                    chainName: 'Binance Smart Chain',
                                    nativeCurrency: {
                                        name: 'BNB',
                                        symbol: 'BNB',
                                        decimals: 18
                                    },
                                    rpcUrls: ['https://bsc-dataseed.binance.org/'],
                                    blockExplorerUrls: ['https://bscscan.com/']
                                }
                            ]
                        });
                    } catch (addError) {
                        console.error('Error adding BSC network:', addError);
                        showToast('Failed to add BSC network', 'error');
                    }
                } else {
                    console.error('Error switching to BSC:', error);
                    showToast('Failed to switch network', 'error');
                }
            }
        }

        // Add token to wallet
        async function addTokenToWallet() {
            if (!window.ethereum) {
                showToast('Please install TokenPocket wallet first', 'error');
                return;
            }
            
            try {
                const tokenAdded = await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: {
                        type: 'ERC20',
                        options: {
                            address: contractAddress,
                            symbol: 'KDK',
                            decimals: 18,
                            image: 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/smartchain/assets/0x6bfcA5254F4C106AD9173434da7DC26C5120eB6C/logo.png'
                        }
                    }
                });
                
                if (tokenAdded) {
                    showToast('Token added to wallet successfully!', 'success');
                } else {
                    showToast('Failed to add token to wallet', 'error');
                }
            } catch (error) {
                console.error('Error adding token to wallet:', error);
                showToast('Failed to add token to wallet', 'error');
            }
        }

        // Update wallet UI
        function updateWalletUI() {
            if (isConnected && userAddress) {
                // Shorten address for display
                const shortenedAddress = userAddress.substring(0, 6) + '...' + userAddress.substring(38);
                connectWalletBtn.innerHTML = `<i class="fas fa-check-circle"></i><span>${shortenedAddress}</span>`;
                connectWalletBtn.classList.add('connected');
                
                connectedAddressEl.textContent = shortenedAddress;
            } else {
                connectWalletBtn.innerHTML = '<i class="fas fa-wallet"></i><span>Connect Wallet</span>';
                connectWalletBtn.classList.remove('connected');
                
                connectedAddressEl.textContent = 'Not connected';
                userBalanceEl.textContent = '0 KDK';
            }
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            toastContainer.appendChild(toast);
            
            // Remove toast after 5 seconds
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Helper function to validate Ethereum address
        function isValidEthereumAddress(address) {
            return /^0x[a-fA-F0-9]{40}$/.test(address);
        }

        // Helper function to shorten address
        function shortenAddress(address) {
            if (!address) return '';
            return address.substring(0, 6) + '...' + address.substring(38);
        }

        // Handle tab visibility for TokenPocket
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && isConnected) {
                // Reload contract data when app becomes visible again
                loadContractData();
            }
        });
    </script>
    
    <!-- Web3.js library for TokenPocket compatibility -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
</body>
</html>
