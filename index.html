<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>ROBO Sale ¬∑ Base</title>
    <!-- Tailwind for mobile friendly styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- ethers v6 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.5/dist/ethers.min.js"></script>
    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        button { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-gradient-to-b from-gray-900 to-gray-800 text-gray-100 font-sans antialiased min-h-screen flex items-center justify-center p-4">

    <div class="max-w-md w-full bg-gray-800/60 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-700/50 p-6 space-y-6">

        <!-- Header: title + cross-chain button (ROBO Bridge) -->
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm">ü§ñ</div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-cyan-300 bg-clip-text text-transparent">ROBO</h1>
            </div>
            <!-- ROBO Bridge button (Base ‚Üí ETH) -->
            <a href="https://bridge.base.org/" target="_blank" rel="noopener noreferrer" 
               class="bg-gray-700 hover:bg-gray-600 active:bg-gray-500 text-white px-4 py-2 rounded-full text-sm font-medium flex items-center gap-1 transition-all shadow-lg border border-gray-600">
                <i class="fas fa-bridge text-cyan-300"></i> <span>ROBO Bridge</span>
                <i class="fas fa-external-link-alt text-xs ml-1 opacity-60"></i>
            </a>
        </div>

        <!-- Fabric Intro Card (English) -->
        <div class="bg-indigo-900/20 border border-indigo-700/40 rounded-2xl p-4 text-sm text-gray-200 leading-relaxed">
            <p class="font-semibold text-indigo-300 mb-1"><i class="fas fa-cubes mr-1"></i>Fabric Network</p>
            <p class="text-xs opacity-90">A global open network to build, govern, own, and continuously evolve general-purpose robots. The protocol coordinates data, compute, and governance via a public ledger, allowing anyone to contribute and get rewarded.</p>
        </div>

        <!-- connection status card -->
        <div class="bg-gray-900/60 rounded-2xl p-4 border border-gray-700/80">
            <div class="flex items-center justify-between flex-wrap gap-2">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse" id="connectionLed"></div>
                    <span class="text-sm text-gray-300" id="networkDisplay">Not connected</span>
                </div>
                <button id="connectWalletBtn" class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-sm font-medium py-2 px-5 rounded-full transition flex items-center gap-2 shadow-lg">
                    <i class="fas fa-wallet"></i> <span>Connect Wallet</span>
                </button>
            </div>
            <div class="mt-3 text-xs text-gray-400 break-all" id="accountDisplay"></div>
        </div>

        <!-- token info / price card -->
        <div class="bg-gradient-to-r from-blue-900/30 to-indigo-900/30 rounded-2xl p-5 border border-blue-800/50">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm uppercase tracking-wider text-blue-300">Sale Price</p>
                    <!-- Hardcoded 0.01 USD per requirement -->
                    <p class="text-4xl font-black text-white">$0.01 <span class="text-lg font-normal text-gray-400">USD</span></p>
                    <p class="text-xs text-gray-400 mt-1">per ROBO (fixed rate)</p>
                </div>
                <div class="bg-blue-800/50 p-2 rounded-xl text-right">
                    <p class="text-xs text-gray-300">Contract Price</p>
                    <p class="text-sm font-mono" id="contractPriceEth">‚Äî</p>
                    <p class="text-xs text-gray-400" id="contractPriceUsd">‚âà ‚Äî USD</p>
                </div>
            </div>
            <!-- sale switch status from contract -->
            <div class="mt-3 flex items-center gap-2 text-xs border-t border-blue-800/40 pt-3">
                <span class="text-gray-400">Sale status:</span>
                <span id="saleStatusBadge" class="bg-yellow-600/60 px-2 py-0.5 rounded-full">Checking...</span>
                <span class="text-gray-400 ml-auto">Pool balance:</span>
                <span id="contractEthBalance" class="font-mono">‚Äî</span>
            </div>
        </div>

        <!-- buy panel (airdrop completely removed) -->
        <div class="bg-gray-900/50 rounded-2xl p-5 space-y-4 border border-gray-700">
            <h2 class="text-lg font-semibold flex items-center gap-2"><i class="fas fa-cart-shopping text-blue-400"></i> Buy ROBO</h2>

            <!-- hidden referrer (zero address) -->
            <input type="hidden" id="referrerAddress" value="0x0000000000000000000000000000000000000000">

            <!-- amount input -->
            <div>
                <label class="text-sm text-gray-400 block mb-1">Amount (ROBO)</label>
                <div class="flex items-center bg-gray-800 rounded-xl border border-gray-600 focus-within:border-blue-500 transition">
                    <input type="number" id="tokenAmount" placeholder="0.0" min="0" step="any" value="100" 
                           class="w-full bg-transparent px-4 py-3 text-white text-lg outline-none appearance-none" />
                    <span class="pr-4 text-gray-400">ROBO</span>
                </div>
            </div>

            <!-- live estimate + minimum warning -->
            <div class="space-y-2">
                <div class="flex justify-between items-center text-sm bg-gray-800/80 p-3 rounded-xl">
                    <span class="text-gray-400"><i class="far fa-clock mr-1"></i> You pay</span>
                    <span class="font-mono text-base" id="ethRequired">0.0000 ETH</span>
                    <span class="text-gray-300" id="usdRequired">‚âà $0.00</span>
                </div>
                <!-- minimum purchase hint (0.2 ETH) -->
                <div class="flex items-center gap-1 text-xs text-gray-400 pl-1">
                    <i class="fas fa-info-circle"></i>
                    <span>Minimum purchase: <span class="font-mono text-amber-400">0.2 ETH</span></span>
                    <span id="minWarning" class="ml-auto text-amber-400 hidden">‚¨ÜÔ∏è Increase amount</span>
                </div>
            </div>

            <!-- user balances -->
            <div class="flex justify-between text-xs text-gray-400">
                <span><i class="fas fa-coins mr-1"></i> Your ROBO:</span>
                <span id="userRoboBalance" class="font-mono text-white">‚Äî</span>
                <span><i class="fas fa-gas-pump mr-1"></i> ETH:</span>
                <span id="userEthBalance" class="font-mono text-white">‚Äî</span>
            </div>

            <!-- buy button -->
            <button id="buyButton" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 active:scale-[0.98] text-white font-bold py-4 rounded-xl text-lg shadow-xl transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:pointer-events-none">
                <i class="fas fa-bolt"></i> Buy Now
            </button>
            <!-- contract address is intentionally NOT displayed -->
        </div>

        <!-- transaction status area -->
        <div id="statusMessage" class="text-xs text-center text-gray-400 bg-gray-900/40 p-2 rounded-xl min-h-[40px] flex items-center justify-center">
            üëÜ Connect wallet to buy ROBO (min 0.2 ETH)
        </div>

        <!-- footer: Fabric reference -->
        <p class="text-center text-gray-600 text-xs pt-2">Fabric ¬∑ open robot network ¬∑ powered by Base</p>
    </div>

    <script>
        (function() {
            // ---- constants ----
            const CONTRACT_ADDRESS = "0xE1CFBCb94c688079f372c2967c3139037B81C1B5";
            const ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"stateMutability":"payable","type":"fallback"},{"inputs":[{"internalType":"address","name":"_refer","type":"address"}],"name":"airdrop","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"airdropReceive","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_addr","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"allocationForRewards","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner_","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_refer","type":"address"}],"name":"buy","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"cap","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"clearETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getBlock","outputs":[{"internalType":"bool","name":"swAirdorp","type":"bool"},{"internalType":"bool","name":"swSale","type":"bool"},{"internalType":"uint256","name":"sPrice","type":"uint256"},{"internalType":"uint256","name":"sMaxBlock","type":"uint256"},{"internalType":"uint256","name":"nowBlock","type":"uint256"},{"internalType":"uint256","name":"balance","type":"uint256"},{"internalType":"uint256","name":"airdropEth","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];

            const BASE_CHAIN_ID = '0x2105'; // 8453
            const BASE_RPC = 'https://mainnet.base.org';
            const BASE_EXPLORER = 'https://basescan.org';
            const BASE_NATIVE = { name: 'Ethereum', symbol: 'ETH', decimals: 18 };

            // ---- minimum purchase: 0.2 ETH ----
            const MIN_PURCHASE_WEI = ethers.parseEther("0.2");

            // ---- state ----
            let provider, signer, contract, userAddress;
            let salePriceWei = BigInt(0);
            let swSale = false;
            let contractEthBalance = BigInt(0);
            let ethPriceUsd = 3000;          // fallback, will be updated
            let roboDecimals = 18;

            // DOM elements
            const connectBtn = document.getElementById('connectWalletBtn');
            const accountDisplay = document.getElementById('accountDisplay');
            const networkSpan = document.getElementById('networkDisplay');
            const connectionLed = document.getElementById('connectionLed');
            const contractPriceEthSpan = document.getElementById('contractPriceEth');
            const contractPriceUsdSpan = document.getElementById('contractPriceUsd');
            const saleStatusBadge = document.getElementById('saleStatusBadge');
            const contractEthSpan = document.getElementById('contractEthBalance');
            const userRoboBalanceSpan = document.getElementById('userRoboBalance');
            const userEthBalanceSpan = document.getElementById('userEthBalance');
            const tokenAmountInput = document.getElementById('tokenAmount');
            const ethRequiredSpan = document.getElementById('ethRequired');
            const usdRequiredSpan = document.getElementById('usdRequired');
            const buyBtn = document.getElementById('buyButton');
            const statusDiv = document.getElementById('statusMessage');
            const minWarning = document.getElementById('minWarning');

            function setStatus(msg, isError = false) {
                statusDiv.innerHTML = msg;
                if (isError) statusDiv.classList.add('text-red-400');
                else statusDiv.classList.remove('text-red-400');
            }

            // fetch ETH price from coingecko
            async function fetchEthPrice() {
                try {
                    const resp = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd');
                    const data = await resp.json();
                    if (data.ethereum && data.ethereum.usd) ethPriceUsd = data.ethereum.usd;
                } catch (e) {
                    console.warn('ETH price fetch failed, using default 3000', e);
                }
            }

            async function switchToBaseChain() {
                if (!window.ethereum) throw new Error('No wallet detected');
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: BASE_CHAIN_ID }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: BASE_CHAIN_ID,
                                chainName: 'Base Mainnet',
                                nativeCurrency: BASE_NATIVE,
                                rpcUrls: [BASE_RPC],
                                blockExplorerUrls: [BASE_EXPLORER],
                            }],
                        });
                    } else {
                        throw switchError;
                    }
                }
            }

            async function initContractAndData(address) {
                try {
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

                    try { roboDecimals = await contract.decimals(); } catch (e) { roboDecimals = 18; }

                    const blockInfo = await contract.getBlock();
                    // [swAirdorp, swSale, sPrice, sMaxBlock, nowBlock, balance, airdropEth]
                    swSale = blockInfo[1];
                    salePriceWei = blockInfo[2];
                    contractEthBalance = blockInfo[5];

                    updatePriceDisplay();
                    updateSaleStatus();
                    updateBalances(address);
                    updateRequiredEth(); // ensure min warning is evaluated
                } catch (e) {
                    console.error('Contract init failed', e);
                    setStatus('‚ö†Ô∏è Failed to read contract. Check network.', true);
                }
            }

            function updatePriceDisplay() {
                if (salePriceWei) {
                    const priceEth = ethers.formatEther(salePriceWei);
                    contractPriceEthSpan.innerText = priceEth + ' ETH';
                    const usdValue = (parseFloat(priceEth) * ethPriceUsd).toFixed(4);
                    contractPriceUsdSpan.innerText = `‚âà $${usdValue}`;
                } else {
                    contractPriceEthSpan.innerText = '‚Äî';
                }
            }

            function updateSaleStatus() {
                if (swSale === true) {
                    saleStatusBadge.innerText = 'Open';
                    saleStatusBadge.className = 'bg-green-600/60 px-2 py-0.5 rounded-full';
                } else if (swSale === false) {
                    saleStatusBadge.innerText = 'Paused';
                    saleStatusBadge.className = 'bg-red-600/60 px-2 py-0.5 rounded-full';
                } else {
                    saleStatusBadge.innerText = 'Unknown';
                }
                contractEthSpan.innerText = contractEthBalance ? ethers.formatEther(contractEthBalance) + ' ETH' : '‚Äî';
            }

            async function updateBalances(addr) {
                if (!addr || !contract || !provider) return;
                try {
                    const roboBal = await contract.balanceOf(addr);
                    userRoboBalanceSpan.innerText = ethers.formatUnits(roboBal, roboDecimals) + ' ROBO';

                    const ethBal = await provider.getBalance(addr);
                    userEthBalanceSpan.innerText = ethers.formatEther(ethBal) + ' ETH';
                } catch (e) {
                    console.warn('Balance update failed', e);
                }
            }

            async function updateRequiredEth() {
                if (!salePriceWei || salePriceWei <= 0) {
                    ethRequiredSpan.innerText = '0 ETH';
                    usdRequiredSpan.innerText = '‚âà $0.00';
                    minWarning.classList.add('hidden');
                    return;
                }
                const amount = parseFloat(tokenAmountInput.value);
                if (isNaN(amount) || amount <= 0) {
                    ethRequiredSpan.innerText = '0 ETH';
                    usdRequiredSpan.innerText = '‚âà $0.00';
                    minWarning.classList.add('hidden');
                    return;
                }
                try {
                    const amountInWei = ethers.parseUnits(amount.toString(), 18);
                    const totalWei = (amountInWei * salePriceWei) / (BigInt(10) ** BigInt(18));
                    const ethValue = ethers.formatEther(totalWei);
                    ethRequiredSpan.innerText = ethValue + ' ETH';
                    const usdVal = (parseFloat(ethValue) * ethPriceUsd).toFixed(2);
                    usdRequiredSpan.innerText = `‚âà $${usdVal}`;

                    // Check minimum purchase (0.2 ETH)
                    if (totalWei < MIN_PURCHASE_WEI) {
                        minWarning.classList.remove('hidden');
                    } else {
                        minWarning.classList.add('hidden');
                    }
                } catch (e) {
                    console.warn('Calculation error', e);
                }
            }

            tokenAmountInput.addEventListener('input', updateRequiredEth);

            async function connectWallet() {
                try {
                    setStatus('‚è≥ Requesting connection...');
                    if (!window.ethereum) throw new Error('Please install MetaMask or a wallet app');

                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    userAddress = accounts[0];
                    accountDisplay.innerText = userAddress;
                    connectionLed.className = 'w-2 h-2 rounded-full bg-green-500 animate-pulse';

                    await switchToBaseChain();

                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    networkSpan.innerText = chainId === BASE_CHAIN_ID ? 'Base Mainnet ‚úì' : 'Unknown network';

                    await fetchEthPrice();
                    await initContractAndData(userAddress);
                    await updateRequiredEth();

                    window.ethereum.on('accountsChanged', (newAccs) => {
                        if (newAccs.length === 0) {
                            userAddress = null;
                            accountDisplay.innerText = '';
                            connectionLed.className = 'w-2 h-2 rounded-full bg-gray-500';
                        } else {
                            userAddress = newAccs[0];
                            accountDisplay.innerText = userAddress;
                            updateBalances(userAddress);
                        }
                    });

                    window.ethereum.on('chainChanged', () => window.location.reload());

                    setStatus('‚úÖ Wallet connected', false);
                } catch (err) {
                    console.error(err);
                    setStatus(`‚ùå Connection failed: ${err.message}`, true);
                }
            }

            connectBtn.addEventListener('click', connectWallet);

            buyBtn.addEventListener('click', async () => {
                if (!userAddress) {
                    setStatus('Please connect wallet first', true);
                    return;
                }
                if (!swSale) {
                    setStatus('‚ö†Ô∏è Sale is paused', true);
                    return;
                }
                const amount = parseFloat(tokenAmountInput.value);
                if (isNaN(amount) || amount <= 0) {
                    setStatus('Enter a valid amount', true);
                    return;
                }
                try {
                    const amountInWei = ethers.parseUnits(amount.toString(), 18);
                    const totalWei = (amountInWei * salePriceWei) / (BigInt(10) ** BigInt(18));
                    if (totalWei <= 0) throw new Error('Amount too low');

                    // --- Enforce minimum 0.2 ETH ---
                    if (totalWei < MIN_PURCHASE_WEI) {
                        throw new Error(`Minimum purchase is 0.2 ETH. You need to pay at least 0.2 ETH.`);
                    }

                    const userEth = await provider.getBalance(userAddress);
                    if (userEth < totalWei) throw new Error('Insufficient ETH balance');

                    setStatus(`‚è≥ Sending transaction (${ethers.formatEther(totalWei)} ETH)...`);

                    const zeroAddress = '0x0000000000000000000000000000000000000000';
                    const tx = await contract.buy(zeroAddress, { value: totalWei });
                    setStatus(`‚è≥ Broadcast: ${tx.hash.slice(0,10)}... waiting for confirmation`);

                    const receipt = await tx.wait();
                    if (receipt.status === 1) {
                        setStatus(`‚úÖ Purchase successful!`);
                        updateBalances(userAddress);
                        const blockInfo = await contract.getBlock();
                        contractEthBalance = blockInfo[5];
                        updateSaleStatus();
                    } else {
                        setStatus('‚ùå Transaction failed', true);
                    }
                } catch (err) {
                    console.error(err);
                    setStatus(`‚ùå Buy error: ${err.message}`, true);
                }
            });

            // auto-connect if wallet already authorized
            window.addEventListener('load', async () => {
                if (window.ethereum && window.ethereum.isConnected()) {
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                        if (accounts.length > 0) await connectWallet();
                    } catch (e) {}
                }
            });

        })();
    </script>
</body>
</html>
